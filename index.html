<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœåŠ¡è®°å½•ç»Ÿè®¡åˆ†æ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            font-size: 14px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1a73e8 0%, #6c8ef5 100%);
            color: white;
            padding: 25px 30px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .main-content {
            display: flex;
            min-height: 600px;
        }
        
        .sidebar {
            width: 380px;
            background-color: #f9fafc;
            border-right: 1px solid #eaeaea;
            padding: 20px;
            overflow-y: auto;
        }
        
        .content {
            flex: 1;
            padding: 20px;
            overflow-x: auto;
        }
        
        .section-title {
            font-size: 18px;
            color: #1a73e8;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-export {
            background-color: #34a853;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: background-color 0.3s;
        }
        
        .btn-export:hover {
            background-color: #2e8b47;
        }
        
        .btn-export.pdf {
            background-color: #ea4335;
        }
        
        .btn-export.pdf:hover {
            background-color: #d33426;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #555;
            font-size: 13px;
        }
        
        .form-control {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
            transition: border 0.3s;
        }
        
        .form-control:focus {
            border-color: #1a73e8;
            outline: none;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        
        .date-range-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        .date-range-row .form-control {
            flex: 1;
        }
        
        .date-range-row span {
            color: #777;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #1a73e8;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0d62d9;
        }
        
        .btn-secondary {
            background-color: #f1f3f4;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #e3e6e8;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .statistics-summary {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .summary-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            flex: 1;
            min-width: 180px;
        }
        
        .summary-card.total-items {
            border-left: 4px solid #1a73e8;
        }
        
        .summary-card.avg-record-rate {
            border-left: 4px solid #9c27b0;
        }
        
        .summary-card.avg-duration-per-order {
            border-left: 4px solid #00b894;
        }
        
        .summary-card.avg-daily-per-person {
            border-left: 4px solid #e17055;
        }
        
        .summary-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
        }
        
        .summary-value {
            font-size: 20px;
            font-weight: 700;
        }
        
        .summary-card.total-items .summary-value {
            color: #1a73e8;
        }
        
        .summary-card.avg-record-rate .summary-value {
            color: #9c27b0;
        }
        
        .summary-card.avg-duration-per-order .summary-value {
            color: #00b894;
        }
        
        .summary-card.avg-daily-per-person .summary-value {
            color: #e17055;
        }
        
        .statistics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .statistics-table th {
            background-color: #f1f3f4;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #ddd;
            font-size: 13px;
        }
        
        .statistics-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
        }
        
        .statistics-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .percentage-cell {
            font-weight: 600;
            text-align: center;
        }
        
        .percentage-high {
            color: #34a853;
        }
        
        .percentage-medium {
            color: #fbbc04;
        }
        
        .percentage-low {
            color: #ea4335;
        }
        
        .duration-cell {
            font-weight: 600;
            text-align: center;
        }
        
        .people-cell {
            font-weight: 600;
            text-align: center;
        }
        
        .service-type-cell {
            text-align: center;
        }
        
        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #777;
            font-size: 14px;
        }
        
        .no-data div {
            font-size: 40px;
            margin-bottom: 15px;
            color: #ccc;
        }
        
        /* æ ‘å½¢é€‰æ‹©å™¨æ ·å¼ */
        .tree-selector {
            margin-bottom: 20px;
        }
        
        .tree-selector .btn {
            width: 100%;
            text-align: left;
            position: relative;
            padding-right: 40px;
        }
        
        .tree-selector .btn::after {
            content: 'â–¼';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
        }
        
        .tree-selector .btn.active::after {
            content: 'â–²';
        }
        
        .tree-container {
            border: 1px solid #eaeaea;
            border-radius: 8px;
            padding: 15px;
            background-color: white;
            margin-top: 10px;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }
        
        .tree-container.active {
            display: block;
        }
        
        .tree-item {
            padding: 8px 10px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 13px;
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .tree-item:hover {
            background-color: #f0f7ff;
        }
        
        .tree-item.selected {
            background-color: #e3f2fd;
            font-weight: 600;
            color: #1a73e8;
        }
        
        .tree-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #666;
            font-size: 12px;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .tree-checkmark {
            width: 16px;
            height: 16px;
            border: 2px solid #ddd;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .tree-item.selected .tree-checkmark {
            background-color: #1a73e8;
            border-color: #1a73e8;
        }
        
        .tree-item.selected .tree-checkmark::after {
            content: 'âœ“';
            color: white;
            font-size: 12px;
        }
        
        .tree-item-text {
            flex: 1;
        }
        
        .tree-item.level-1 {
            padding-left: 10px;
        }
        
        .tree-item.level-2 {
            padding-left: 30px;
        }
        
        .tree-item.level-3 {
            padding-left: 50px;
        }
        
        /* å·²é€‰æ‹©æ ‡ç­¾æ ·å¼ */
        .selected-tags {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .selected-tag {
            background-color: #e3f2fd;
            border: 1px solid #1a73e8;
            border-radius: 15px;
            padding: 4px 10px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .remove-tag {
            background: none;
            border: none;
            color: #1a73e8;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-tag:hover {
            color: #ea4335;
        }
        
        /* æœåŠ¡ç±»å‹å‹¾é€‰æ¡†æ ·å¼ */
        .service-type-group {
            margin-bottom: 16px;
        }
        
        .service-type-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: #555;
            font-size: 13px;
        }
        
        .service-type-container {
            border: 1px solid #eaeaea;
            border-radius: 8px;
            padding: 12px;
            background-color: white;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .service-type-item {
            padding: 6px 8px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 13px;
            display: flex;
            align-items: center;
        }
        
        .service-type-item:hover {
            background-color: #f0f7ff;
        }
        
        .service-type-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid #ddd;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            flex-shrink: 0;
            cursor: pointer;
        }
        
        .service-type-item.selected .service-type-checkbox {
            background-color: #1a73e8;
            border-color: #1a73e8;
        }
        
        .service-type-item.selected .service-type-checkbox::after {
            content: 'âœ“';
            color: white;
            font-size: 12px;
        }
        
        .service-type-text {
            flex: 1;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #eaeaea;
                max-height: 500px;
            }
            
            .statistics-summary {
                flex-direction: column;
            }
        }
        
        @media (max-width: 768px) {
            .statistics-table {
                display: block;
                overflow-x: auto;
            }
            
            .date-range-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .export-buttons {
                flex-direction: column;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>æœåŠ¡è®°å½•ç»Ÿè®¡åˆ†æ</h1>
            <p>ç»Ÿè®¡æ“ä½œå‘˜ã€å®¢æˆ·åœ°å€çš„æœåŠ¡è®°å½•æƒ…å†µ</p>
        </header>
        
        <div class="main-content">
            <div class="sidebar">
                <h2 class="section-title">ç»Ÿè®¡æ¡ä»¶è®¾ç½®</h2>
                
                <div class="tree-selector">
                    <button class="btn btn-secondary" onclick="toggleTree('address')" id="addressBtn">é€‰æ‹©ç½‘æ ¼åœ°å€</button>
                    <div class="tree-container" id="addressTree"></div>
                    <div class="selected-tags" id="addressTags"></div>
                </div>
                
                <div class="tree-selector">
                    <button class="btn btn-secondary" onclick="toggleTree('operator')" id="operatorBtn">é€‰æ‹©æ“ä½œå‘˜</button>
                    <div class="tree-container" id="operatorTree"></div>
                    <div class="selected-tags" id="operatorTags"></div>
                </div>
                
                <div class="service-type-group">
                    <div class="service-type-title">æœåŠ¡ç±»å‹é€‰æ‹©</div>
                    <div class="service-type-container" id="serviceTypeContainer"></div>
                    <div class="selected-tags" id="serviceTypeTags"></div>
                </div>
                
                <div class="form-group">
                    <label for="dateRange">ç»Ÿè®¡æ—¶é—´æ®µ</label>
                    <div class="date-range-row">
                        <input type="date" id="startDate" class="form-control" value="2025-12-01">
                        <span>è‡³</span>
                        <input type="date" id="endDate" class="form-control" value="2025-12-01">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary btn-block" onclick="queryStatistics()">æŸ¥è¯¢ç»Ÿè®¡</button>
                    <button class="btn btn-secondary btn-block" onclick="resetForm()">é‡ç½®æ‰€æœ‰æ¡ä»¶</button>
                </div>
            </div>
            
            <div class="content">
                <div class="section-title">
                    <span>ç»Ÿè®¡ç»“æœ</span>
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToExcel()">å¯¼å‡ºExcel</button>
                        <button class="btn-export pdf" onclick="exportToPDF()">å¯¼å‡ºPDF</button>
                    </div>
                </div>
                
                <div class="statistics-summary" id="statisticsSummary"></div>
                
                <div class="table-container">
                    <table class="statistics-table" id="resultTable">
                        <thead id="resultTableHead"></thead>
                        <tbody id="resultBody"></tbody>
                    </table>
                </div>
                
                <div class="no-data" id="noDataMessage">
                    <div>ğŸ“Š</div>
                    <h3>æš‚æ— ç»Ÿè®¡æ•°æ®</h3>
                    <p>è¯·è®¾ç½®ç»Ÿè®¡æ¡ä»¶å¹¶ç‚¹å‡»"æŸ¥è¯¢ç»Ÿè®¡"æŒ‰é’®æŸ¥çœ‹ç»“æœ</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æœåŠ¡ç±»å‹æ•°æ®
        const serviceTypes = [
            { id: "å¼€æˆ·å®‰è£…", name: "å¼€æˆ·å®‰è£…" },
            { id: "è®¾å¤‡ç»´æŠ¤", name: "è®¾å¤‡ç»´æŠ¤" },
            { id: "æ•…éšœç»´ä¿®", name: "æ•…éšœç»´ä¿®" },
            { id: "ååŠ©è°ƒè¯•", name: "ååŠ©è°ƒè¯•" },
            { id: "è¥é”€å’¨è¯¢", name: "è¥é”€å’¨è¯¢" }
        ];

        // ç»„ç»‡ç»“æ„æ•°æ®
        const organizationalStructure = {
            operators: [
                {
                    id: "å’Œå¹³æ²³è¥¿åˆ†å…¬å¸",
                    name: "å’Œå¹³æ²³è¥¿åˆ†å…¬å¸",
                    level: 1,
                    expanded: false,
                    children: generateOperators(10, "å’Œå¹³æ²³è¥¿")
                },
                {
                    id: "æ»¨æµ·åˆ†å…¬å¸",
                    name: "æ»¨æµ·åˆ†å…¬å¸",
                    level: 1,
                    expanded: false,
                    children: generateOperators(20, "æ»¨æµ·")
                },
                {
                    id: "åŒ—è¾°åˆ†å…¬å¸",
                    name: "åŒ—è¾°åˆ†å…¬å¸",
                    level: 1,
                    expanded: false,
                    children: generateOperators(7, "åŒ—è¾°")
                }
            ],
            
            addresses: [
                {
                    id: "æ€»å…¬å¸",
                    name: "æ€»å…¬å¸",
                    level: 1,
                    expanded: false,
                    children: [
                        {
                            id: "å’Œå¹³æ²³è¥¿åˆ†å…¬å¸",
                            name: "å’Œå¹³æ²³è¥¿åˆ†å…¬å¸",
                            level: 2,
                            expanded: false,
                            children: generateGrids(5, "å’Œå¹³æ²³è¥¿")
                        },
                        {
                            id: "æ»¨æµ·åˆ†å…¬å¸",
                            name: "æ»¨æµ·åˆ†å…¬å¸",
                            level: 2,
                            expanded: false,
                            children: generateGrids(5, "æ»¨æµ·")
                        },
                        {
                            id: "åŒ—è¾°åˆ†å…¬å¸",
                            name: "åŒ—è¾°åˆ†å…¬å¸",
                            level: 2,
                            expanded: false,
                            children: generateGrids(5, "åŒ—è¾°")
                        }
                    ]
                }
            ]
        };

        // å…¨å±€å˜é‡
        let selectedItems = {
            address: [],
            operator: [],
            serviceType: []
        };
        
        let currentTree = null;
        let currentQueryType = null;
        let currentStats = [];

        // ç”Ÿæˆæ¨¡æ‹Ÿæ“ä½œå‘˜å§“å
        function generateOperators(count, prefix) {
            const surnames = ['ç‹', 'æ', 'å¼ ', 'åˆ˜', 'é™ˆ', 'æ¨', 'èµµ', 'é»„', 'å‘¨', 'å´', 
                           'å¾', 'å­™', 'èƒ¡', 'æœ±', 'é«˜', 'æ—', 'ä½•', 'éƒ­', 'é©¬', 'ç½—'];
            const names = ['ä¼Ÿ', 'èŠ³', 'å¨œ', 'å®‡', 'æ•', 'é™', 'ä¸½', 'å¼º', 'ç£Š', 'å†›', 
                         'æ´‹', 'å‹‡', 'æ´‹', 'æ°', 'é£', 'æ¶›', 'æ˜', 'è¶…', 'æ¢“æ¶µ', 'å†¬å†¬', 
                         'å¹³', 'å°é›¨', 'å', 'ä¸€åš', 'æ–‡', 'å', 'è½©', 'çº¢', 'é¹', 'åš'];
            
            const operators = [];
            for (let i = 1; i <= count; i++) {
                const surname = surnames[Math.floor(Math.random() * surnames.length)];
                const name = names[Math.floor(Math.random() * names.length)];
                const id = String(520000 + i).padStart(6, '0');
                operators.push({
                    id: `${prefix}-op${i}`,
                    name: `${surname}${name}ï¼ˆ${id}ï¼‰`,
                    level: 2,
                    children: []
                });
            }
            return operators;
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿç½‘æ ¼åç§°
        function generateGrids(count, prefix) {
            const areas = ['ä¸œ', 'è¥¿', 'å—', 'åŒ—', 'ä¸­', 'æ–°', 'è€', 'å¤§', 'å°'];
            const types = ['ç½‘æ ¼'];
            
            const grids = [];
            for (let i = 1; i <= count; i++) {
                const area = areas[Math.floor(Math.random() * areas.length)];
                const type = types[Math.floor(Math.random() * types.length)];
                grids.push({
                    id: `${prefix}-grid${i}`,
                    name: `${area}${type}${i}`,
                    level: 3,
                    children: []
                });
            }
            return grids;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initTreeSelectors();
            initServiceTypeCheckboxes();
            setDefaultSelection();
            queryStatistics();
        });

        // è®¾ç½®é»˜è®¤é€‰æ‹©ï¼ˆä¸‰ä¸ªåˆ†å…¬å¸ï¼‰
        function setDefaultSelection() {
            selectedItems = {
                address: [],
                operator: [],
                serviceType: []
            };
            
            const defaultBranches = ["å’Œå¹³æ²³è¥¿åˆ†å…¬å¸", "æ»¨æµ·åˆ†å…¬å¸", "åŒ—è¾°åˆ†å…¬å¸"];
            defaultBranches.forEach(branchId => {
                const findBranch = (nodes) => {
                    for (let node of nodes) {
                        if (node.id === branchId) return node;
                        if (node.children?.length) {
                            const found = findBranch(node.children);
                            if (found) return found;
                        }
                    }
                    return null;
                };
                
                const branch = findBranch(organizationalStructure.addresses);
                if (branch) {
                    selectedItems.address.push({ id: branch.id, name: branch.name, level: branch.level });
                }
            });
            
            const addressTree = document.getElementById('addressTree');
            addressTree.innerHTML = generateTreeHTML(organizationalStructure.addresses, 'address');
            document.getElementById('addressBtn').textContent = `é€‰æ‹©ç½‘æ ¼åœ°å€ (${selectedItems.address.length}é¡¹)`;
            
            updateSelectedTags();
        }

        // åˆå§‹åŒ–æ ‘å½¢é€‰æ‹©å™¨
        function initTreeSelectors() {
            const addressTree = document.getElementById('addressTree');
            addressTree.innerHTML = generateTreeHTML(organizationalStructure.addresses, 'address');
            
            const operatorTree = document.getElementById('operatorTree');
            operatorTree.innerHTML = generateTreeHTML(organizationalStructure.operators, 'operator');
            
            updateSelectedTags();
        }

        // åˆå§‹åŒ–æœåŠ¡ç±»å‹å‹¾é€‰æ¡†
        function initServiceTypeCheckboxes() {
            const serviceTypeContainer = document.getElementById('serviceTypeContainer');
            
            let html = '';
            serviceTypes.forEach(serviceType => {
                const isSelected = selectedItems.serviceType.some(item => item.id === serviceType.id);
                html += `
                    <div class="service-type-item ${isSelected ? 'selected' : ''}" onclick="toggleServiceType('${serviceType.id}')">
                        <div class="service-type-checkbox"></div>
                        <div class="service-type-text">${serviceType.name}</div>
                    </div>
                `;
            });
            
            serviceTypeContainer.innerHTML = html;
            updateSelectedTags();
        }

        // åˆ‡æ¢æœåŠ¡ç±»å‹é€‰æ‹©
        function toggleServiceType(serviceTypeId) {
            const serviceType = serviceTypes.find(st => st.id === serviceTypeId);
            if (!serviceType) return;
            
            const index = selectedItems.serviceType.findIndex(item => item.id === serviceTypeId);
            
            if (index !== -1) {
                selectedItems.serviceType.splice(index, 1);
            } else {
                selectedItems.serviceType.push({ id: serviceType.id, name: serviceType.name });
            }
            
            const serviceTypeItem = document.querySelector(`[onclick="toggleServiceType('${serviceTypeId}')"]`);
            if (serviceTypeItem) {
                serviceTypeItem.classList.toggle('selected');
            }
            
            updateSelectedTags();
        }

        // ç”Ÿæˆæ ‘å½¢ç»“æ„HTML
        function generateTreeHTML(nodes, type, parentExpanded = true) {
            let html = '';
            
            nodes.forEach(node => {
                const isSelected = selectedItems[type].some(item => item.id === node.id);
                const hasChildren = node.children?.length > 0;
                const showChildren = parentExpanded && node.expanded;
                
                html += `
                    <div class="tree-item level-${node.level} ${isSelected ? 'selected' : ''}" 
                         onclick="handleTreeItemClick(event, '${type}', '${node.id}')">
                        ${hasChildren ? `
                            <div class="tree-toggle" onclick="toggleTreeNode(event, '${type}', '${node.id}')">
                                ${node.expanded ? 'âˆ’' : '+'}
                            </div>
                        ` : '<div class="tree-toggle" style="visibility: hidden;"></div>'}
                        <div class="tree-checkmark"></div>
                        <div class="tree-item-text">${node.name}</div>
                    </div>
                `;
                
                if (hasChildren && showChildren) {
                    html += generateTreeHTML(node.children, type, showChildren);
                }
            });
            
            return html;
        }

        // åˆ‡æ¢æ ‘èŠ‚ç‚¹å±•å¼€/æŠ˜å 
        function toggleTreeNode(event, type, nodeId) {
            event.stopPropagation();
            
            const nodes = type === 'operator' ? organizationalStructure.operators : organizationalStructure.addresses;
            
            const toggleNode = (nodeList) => {
                for (let node of nodeList) {
                    if (node.id === nodeId) {
                        node.expanded = !node.expanded;
                        return true;
                    }
                    if (node.children?.length) {
                        if (toggleNode(node.children)) return true;
                    }
                }
                return false;
            };
            
            toggleNode(nodes);
            
            const treeElement = document.getElementById(type + 'Tree');
            treeElement.innerHTML = generateTreeHTML(nodes, type);
        }

        // å¤„ç†æ ‘èŠ‚ç‚¹ç‚¹å‡»
        function handleTreeItemClick(event, type, nodeId) {
            event.stopPropagation();
            
            const nodes = type === 'operator' ? organizationalStructure.operators : organizationalStructure.addresses;
            
            const findNode = (nodeList) => {
                for (let node of nodeList) {
                    if (node.id === nodeId) return node;
                    if (node.children?.length) {
                        const found = findNode(node.children);
                        if (found) return found;
                    }
                }
                return null;
            };
            
            const node = findNode(nodes);
            if (!node) return;
            
            const getAllNodes = (currentNode) => {
                const nodes = [currentNode];
                if (currentNode.children?.length) {
                    currentNode.children.forEach(child => {
                        nodes.push(...getAllNodes(child));
                    });
                }
                return nodes;
            };
            
            const allNodes = getAllNodes(node);
            const isSelected = selectedItems[type].some(item => item.id === nodeId);
            
            if (isSelected) {
                allNodes.forEach(n => {
                    const index = selectedItems[type].findIndex(item => item.id === n.id);
                    if (index !== -1) {
                        selectedItems[type].splice(index, 1);
                    }
                });
            } else {
                allNodes.forEach(n => {
                    if (!selectedItems[type].some(item => item.id === n.id)) {
                        selectedItems[type].push({ id: n.id, name: n.name, level: n.level });
                    }
                });
            }
            
            const treeElement = document.getElementById(type + 'Tree');
            treeElement.innerHTML = generateTreeHTML(nodes, type);
            
            document.getElementById(type + 'Btn').textContent = `é€‰æ‹©${getTypeName(type)} (${selectedItems[type].length}é¡¹)`;
            updateSelectedTags();
        }

        // åˆ‡æ¢æ ‘å½¢é€‰æ‹©å™¨æ˜¾ç¤º/éšè—
        function toggleTree(type) {
            if (currentTree === type) {
                document.getElementById(type + 'Tree').classList.remove('active');
                document.getElementById(type + 'Btn').classList.remove('active');
                currentTree = null;
                return;
            }
            
            if (currentTree) {
                document.getElementById(currentTree + 'Tree').classList.remove('active');
                document.getElementById(currentTree + 'Btn').classList.remove('active');
            }
            
            const otherTreeTypes = ['operator', 'address'].filter(t => t !== type);
            otherTreeTypes.forEach(otherType => {
                selectedItems[otherType] = [];
                document.getElementById(otherType + 'Btn').textContent = `é€‰æ‹©${getTypeName(otherType)}`;
                
                const nodes = otherType === 'operator' ? organizationalStructure.operators : organizationalStructure.addresses;
                const treeElement = document.getElementById(otherType + 'Tree');
                treeElement.innerHTML = generateTreeHTML(nodes, otherType);
            });
            
            currentTree = type;
            document.getElementById(type + 'Tree').classList.add('active');
            document.getElementById(type + 'Btn').classList.add('active');
            document.getElementById(type + 'Btn').textContent = `é€‰æ‹©${getTypeName(type)} (${selectedItems[type].length}é¡¹)`;
            
            updateSelectedTags();
        }

        // è·å–ç±»å‹åç§°
        function getTypeName(type) {
            const names = {
                operator: 'æ“ä½œå‘˜',
                address: 'å®¢æˆ·åœ°å€',
                serviceType: 'æœåŠ¡ç±»å‹'
            };
            return names[type] || type;
        }

        // æ›´æ–°å·²é€‰æ‹©æ ‡ç­¾
        function updateSelectedTags() {
            const addressTags = document.getElementById('addressTags');
            addressTags.innerHTML = selectedItems.address.map(item => `
                <div class="selected-tag">
                    ${item.name}
                    <button class="remove-tag" onclick="removeSelectedItem('address', '${item.id}')">&times;</button>
                </div>
            `).join('');
            
            const operatorTags = document.getElementById('operatorTags');
            operatorTags.innerHTML = selectedItems.operator.map(item => `
                <div class="selected-tag">
                    ${item.name}
                    <button class="remove-tag" onclick="removeSelectedItem('operator', '${item.id}')">&times;</button>
                </div>
            `).join('');
            
            const serviceTypeTags = document.getElementById('serviceTypeTags');
            serviceTypeTags.innerHTML = selectedItems.serviceType.map(item => `
                <div class="selected-tag">
                    ${item.name}
                    <button class="remove-tag" onclick="removeSelectedItem('serviceType', '${item.id}')">&times;</button>
                </div>
            `).join('');
        }

        // ç§»é™¤å·²é€‰æ‹©é¡¹ç›®
        function removeSelectedItem(type, id) {
            const index = selectedItems[type].findIndex(item => item.id === id);
            if (index !== -1) {
                selectedItems[type].splice(index, 1);
                
                if (type === 'operator' || type === 'address') {
                    const treeElement = document.getElementById(type + 'Tree');
                    const nodes = type === 'operator' ? organizationalStructure.operators : organizationalStructure.addresses;
                    treeElement.innerHTML = generateTreeHTML(nodes, type);
                    
                    document.getElementById(type + 'Btn').textContent = `é€‰æ‹©${getTypeName(type)} (${selectedItems[type].length}é¡¹)`;
                } else if (type === 'serviceType') {
                    const serviceTypeItem = document.querySelector(`[onclick="toggleServiceType('${id}')"]`);
                    if (serviceTypeItem) {
                        serviceTypeItem.classList.remove('selected');
                    }
                }
                
                updateSelectedTags();
            }
        }

        // æŸ¥è¯¢ç»Ÿè®¡æ•°æ®
        function queryStatistics() {
            if (currentTree) {
                document.getElementById(currentTree + 'Tree').classList.remove('active');
                document.getElementById(currentTree + 'Btn').classList.remove('active');
                currentTree = null;
            }
            
            let queryType = null;
            let queryItems = [];
            
            if (selectedItems.address.length > 0) {
                queryType = 'address';
                queryItems = selectedItems.address;
            } else if (selectedItems.operator.length > 0) {
                queryType = 'operator';
                queryItems = selectedItems.operator;
            } else {
                queryType = 'address';
                if (selectedItems.address.length === 0) {
                    setDefaultSelection();
                    queryItems = selectedItems.address;
                } else {
                    queryItems = selectedItems.address;
                }
            }
            
            currentQueryType = queryType;
            currentStats = generateMockStats(queryItems, queryType);
            
            displayStats(currentStats, queryType);
            updateSummaryStats(currentStats, queryType);
        }

        // è·å–æ‰€æœ‰å¶å­èŠ‚ç‚¹
        function getAllLeafNodes(nodes) {
            let leafNodes = [];
            
            nodes.forEach(node => {
                if (node.children?.length) {
                    leafNodes = leafNodes.concat(getAllLeafNodes(node.children));
                } else {
                    leafNodes.push({ id: node.id, name: node.name, level: node.level });
                }
            });
            
            return leafNodes;
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿç»Ÿè®¡æ•°æ®
        function generateMockStats(items, type) {
            const stats = [];
            const selectedServiceTypes = selectedItems.serviceType;
            
            if (type === 'address') {
                items.forEach(item => {
                    const node = findNodeInStructure(organizationalStructure.addresses, item.id);
                    
                    if (!node) {
                        const stat = generateStatForItem(item.name, false, selectedServiceTypes);
                        stats.push(stat);
                        return;
                    }
                    
                    if (node.children?.length) {
                        const allLeafNodes = getAllLeafNodes([node]);
                        const leafStats = [];
                        
                        allLeafNodes.forEach(leafNode => {
                            const stat = generateStatForItem(leafNode.name, true, selectedServiceTypes);
                            leafStats.push(stat);
                        });
                        
                        const aggregatedStat = {
                            name: item.name,
                            totalOrders: leafStats.reduce((sum, stat) => sum + stat.totalOrders, 0),
                            serviceRecords: leafStats.reduce((sum, stat) => sum + stat.serviceRecords, 0),
                            recordRate: 0,
                            peopleCount: leafStats.reduce((sum, stat) => sum + stat.peopleCount, 0),
                            avgDurationPerOrder: Math.floor(leafStats.reduce((sum, stat) => sum + stat.avgDurationPerOrder, 0) / leafStats.length),
                            avgDailyPerPersonDuration: Math.floor(leafStats.reduce((sum, stat) => sum + stat.avgDailyPerPersonDuration, 0) / leafStats.length)
                        };
                        
                        aggregatedStat.recordRate = aggregatedStat.totalOrders > 0 ? 
                            parseFloat((aggregatedStat.serviceRecords / aggregatedStat.totalOrders * 100).toFixed(1)) : 0;
                        
                        if (selectedServiceTypes.length > 0) {
                            aggregatedStat.serviceType = selectedServiceTypes.length > 1 ? "å¤šç§ç±»å‹" : selectedServiceTypes[0].name;
                        } else {
                            aggregatedStat.serviceType = "å…¨éƒ¨";
                        }
                        
                        stats.push(aggregatedStat);
                    } else {
                        const stat = generateStatForItem(item.name, true, selectedServiceTypes);
                        stats.push(stat);
                    }
                });
            } else if (type === 'operator') {
                items.forEach(item => {
                    const stat = generateStatForItem(item.name, false, selectedServiceTypes);
                    stat.peopleCount = 1;
                    stats.push(stat);
                });
            }
            
            return stats;
        }

        // ä¸ºå•ä¸ªé¡¹ç›®ç”Ÿæˆç»Ÿè®¡æ•°æ®
        function generateStatForItem(name, isLeafNode, selectedServiceTypes) {
            const basePeopleCount = isLeafNode ? Math.floor(Math.random() * 11) + 5 : Math.floor(Math.random() * 11) + 5;
            
            let serviceTypeFactor = 1.0;
            if (selectedServiceTypes.length > 0) {
                serviceTypeFactor = 0.6 + (Math.random() * 0.4);
            }
            
            const adjustedPeopleCount = Math.max(1, Math.floor(basePeopleCount * serviceTypeFactor));
            const multiplier = Math.floor(Math.random() * 7) + 3;
            const totalOrders = adjustedPeopleCount * multiplier;
            const minRecords = Math.max(1, Math.floor(totalOrders * 0.6));
            const serviceRecords = Math.floor(Math.random() * (totalOrders - minRecords)) + minRecords;
            const recordRate = (Math.random() * 53 + 46).toFixed(1);
            const avgDurationPerOrder = Math.floor(Math.random() * 220) + 16;
            const avgDailyPerPersonDuration = Math.floor(Math.random() * 307) + 122;
            
            let serviceTypeDisplay = "å…¨éƒ¨";
            if (selectedServiceTypes.length > 0) {
                if (selectedServiceTypes.length === 1) {
                    serviceTypeDisplay = selectedServiceTypes[0].name;
                } else {
                    serviceTypeDisplay = "å¤šç§ç±»å‹";
                }
            }
            
            return {
                name: name,
                totalOrders: totalOrders,
                serviceRecords: serviceRecords,
                recordRate: parseFloat(recordRate),
                peopleCount: adjustedPeopleCount,
                avgDurationPerOrder: Math.floor(avgDurationPerOrder),
                avgDailyPerPersonDuration: Math.floor(avgDailyPerPersonDuration),
                serviceType: serviceTypeDisplay
            };
        }

        // åœ¨ç»„ç»‡ç»“æ„ä¸­æŸ¥æ‰¾èŠ‚ç‚¹
        function findNodeInStructure(nodes, nodeId) {
            for (let node of nodes) {
                if (node.id === nodeId) return node;
                if (node.children?.length) {
                    const found = findNodeInStructure(node.children, nodeId);
                    if (found) return found;
                }
            }
            return null;
        }

        // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
        function displayStats(stats, type) {
            const resultTableHead = document.getElementById('resultTableHead');
            const resultBody = document.getElementById('resultBody');
            const noDataMessage = document.getElementById('noDataMessage');
            
            if (stats.length === 0) {
                resultTableHead.innerHTML = '';
                resultBody.innerHTML = '';
                noDataMessage.style.display = 'block';
                return;
            }
            
            noDataMessage.style.display = 'none';
            
            const hasServiceTypeSelection = selectedItems.serviceType.length > 0;
            let tableHeaderHTML = `
                <tr>
                    <th>åç§°</th>
            `;
            
            if (hasServiceTypeSelection) {
                tableHeaderHTML += `<th>æœåŠ¡ç±»å‹</th>`;
            }
            
            tableHeaderHTML += `
                    <th>å·¥å•æ•°</th>
                    <th>æœåŠ¡è®°å½•æ•°</th>
                    <th>æœåŠ¡è®°å½•ç‡</th>
                    <th>æœåŠ¡äººæ•°</th>
                    <th>å¹³å‡æ¯å•æœåŠ¡æ—¶é•¿</th>
                    <th>å¹³å‡æ¯äººæ¯æ—¥æœåŠ¡æ—¶é•¿</th>
                </tr>
            `;
            
            resultTableHead.innerHTML = tableHeaderHTML;
            
            let rowsHTML = '';
            stats.forEach(stat => {
                let rateClass = 'percentage-high';
                if (stat.recordRate < 70) {
                    rateClass = 'percentage-low';
                } else if (stat.recordRate < 85) {
                    rateClass = 'percentage-medium';
                }
                
                const formatDuration = (minutes) => {
                    const hours = Math.floor(minutes / 60);
                    const mins = Math.floor(minutes % 60);
                    return `${hours}å°æ—¶${mins}åˆ†é’Ÿ`;
                };
                
                rowsHTML += `
                    <tr>
                        <td><strong>${stat.name}</strong></td>
                `;
                
                if (hasServiceTypeSelection) {
                    rowsHTML += `<td class="service-type-cell">${stat.serviceType}</td>`;
                }
                
                rowsHTML += `
                        <td class="people-cell">${stat.totalOrders}</td>
                        <td class="people-cell">${stat.serviceRecords}</td>
                        <td class="percentage-cell ${rateClass}">${stat.recordRate.toFixed(1)}%</td>
                        <td class="people-cell">${stat.peopleCount}</td>
                        <td class="duration-cell">${formatDuration(stat.avgDurationPerOrder)}</td>
                        <td class="duration-cell">${formatDuration(stat.avgDailyPerPersonDuration)}</td>
                    </tr>
                `;
            });
            
            resultBody.innerHTML = rowsHTML;
        }

        // æ›´æ–°ç»Ÿè®¡æ‘˜è¦
        function updateSummaryStats(stats, type) {
            const summaryElement = document.getElementById('statisticsSummary');
            
            if (stats.length === 0) {
                summaryElement.innerHTML = `
                    <div class="summary-card total-items">
                        <div class="summary-title">ç»Ÿè®¡é¡¹æ•°</div>
                        <div class="summary-value">0</div>
                    </div>
                `;
                return;
            }
            
            const avgRecordRate = stats.reduce((sum, stat) => sum + stat.recordRate, 0) / stats.length;
            const avgDurationPerOrder = stats.reduce((sum, stat) => sum + stat.avgDurationPerOrder, 0) / stats.length;
            const avgDailyPerPersonDuration = stats.reduce((sum, stat) => sum + stat.avgDailyPerPersonDuration, 0) / stats.length;
            
            const formatDuration = (minutes) => {
                const hours = Math.floor(minutes / 60);
                const mins = Math.floor(minutes % 60);
                return `${hours}å°æ—¶${mins}åˆ†é’Ÿ`;
            };
            
            const summaryHTML = `
                <div class="summary-card total-items">
                    <div class="summary-title">ç»Ÿè®¡é¡¹æ•°</div>
                    <div class="summary-value">${stats.length}</div>
                </div>
                <div class="summary-card avg-record-rate">
                    <div class="summary-title">å¹³å‡æœåŠ¡è®°å½•ç‡</div>
                    <div class="summary-value">${avgRecordRate.toFixed(1)}%</div>
                </div>
                <div class="summary-card avg-duration-per-order">
                    <div class="summary-title">å¹³å‡æ¯å•æœåŠ¡æ—¶é•¿</div>
                    <div class="summary-value">${formatDuration(Math.floor(avgDurationPerOrder))}</div>
                </div>
                <div class="summary-card avg-daily-per-person">
                    <div class="summary-title">å¹³å‡æ¯äººæ¯æ—¥æœåŠ¡æ—¶é•¿</div>
                    <div class="summary-value">${formatDuration(Math.floor(avgDailyPerPersonDuration))}</div>
                </div>
            `;
            
            summaryElement.innerHTML = summaryHTML;
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('startDate').value = '2025-12-01';
            document.getElementById('endDate').value = '2025-12-01';
            
            setDefaultSelection();
            
            if (currentTree) {
                document.getElementById(currentTree + 'Tree').classList.remove('active');
                document.getElementById(currentTree + 'Btn').classList.remove('active');
                currentTree = null;
            }
            
            queryStatistics();
        }

        // å¯¼å‡ºåˆ°Excel
        function exportToExcel() {
            if (currentStats.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }
            
            const selectedServiceTypes = selectedItems.serviceType.map(item => item.name).join('ã€');
            const serviceTypeText = selectedServiceTypes ? `æœåŠ¡ç±»å‹: ${selectedServiceTypes}` : 'æœåŠ¡ç±»å‹: å…¨éƒ¨';
            
            const headers = ['åç§°'];
            if (selectedItems.serviceType.length > 0) {
                headers.push('æœåŠ¡ç±»å‹');
            }
            headers.push('å·¥å•æ•°', 'æœåŠ¡è®°å½•æ•°', 'æœåŠ¡è®°å½•ç‡', 'æœåŠ¡äººæ•°', 'å¹³å‡æ¯å•æœåŠ¡æ—¶é•¿', 'å¹³å‡æ¯äººæ¯æ—¥æœåŠ¡æ—¶é•¿');
            
            const data = [
                ['æœåŠ¡è®°å½•ç»Ÿè®¡åˆ†ææŠ¥è¡¨'],
                ['å¯¼å‡ºæ—¶é—´: ' + new Date().toLocaleString('zh-CN')],
                ['æŸ¥è¯¢ç»´åº¦: ' + (currentQueryType === 'operator' ? 'æ“ä½œå‘˜' : 'å®¢æˆ·åœ°å€')],
                [serviceTypeText],
                ['ç»Ÿè®¡æ—¶é—´æ®µ: ' + document.getElementById('startDate').value + ' è‡³ ' + document.getElementById('endDate').value],
                [''],
                headers
            ];
            
            currentStats.forEach(stat => {
                const formatDuration = (minutes) => {
                    const hours = Math.floor(minutes / 60);
                    const mins = Math.floor(minutes % 60);
                    return `${hours}å°æ—¶${mins}åˆ†é’Ÿ`;
                };
                
                const rowData = [stat.name];
                if (selectedItems.serviceType.length > 0) {
                    rowData.push(stat.serviceType);
                }
                rowData.push(
                    stat.totalOrders,
                    stat.serviceRecords,
                    stat.recordRate.toFixed(1) + '%',
                    stat.peopleCount,
                    formatDuration(stat.avgDurationPerOrder),
                    formatDuration(stat.avgDailyPerPersonDuration)
                );
                
                data.push(rowData);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            const colWidths = [
                {wch: 30}, // åç§°
            ];
            if (selectedItems.serviceType.length > 0) {
                colWidths.push({wch: 12}); // æœåŠ¡ç±»å‹
            }
            colWidths.push(
                {wch: 10}, // å·¥å•æ•°
                {wch: 12}, // æœåŠ¡è®°å½•æ•°
                {wch: 12}, // æœåŠ¡è®°å½•ç‡
                {wch: 10}, // æœåŠ¡äººæ•°
                {wch: 18}, // å¹³å‡æ¯å•æœåŠ¡æ—¶é•¿
                {wch: 20}  // å¹³å‡æ¯äººæ¯æ—¥æœåŠ¡æ—¶é•¿
            );
            ws['!cols'] = colWidths;
            
            const mergeRanges = [
                XLSX.utils.decode_range("A1:G1"),
                XLSX.utils.decode_range("A2:G2"),
                XLSX.utils.decode_range("A3:G3"),
                XLSX.utils.decode_range("A4:G4"),
                XLSX.utils.decode_range("A5:G5")
            ];
            if (selectedItems.serviceType.length > 0) {
                mergeRanges.forEach(range => {
                    range.e.c = range.e.c + 1;
                });
            }
            ws['!merges'] = mergeRanges;
            
            XLSX.utils.book_append_sheet(wb, ws, "æœåŠ¡è®°å½•ç»Ÿè®¡");
            
            const fileName = `æœåŠ¡è®°å½•ç»Ÿè®¡_${new Date().toISOString().slice(0, 10)}.xlsx`;
            
            XLSX.writeFile(wb, fileName);
        }

        // å¯¼å‡ºåˆ°PDF
        function exportToPDF() {
            if (currentStats.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }
            
            try {
                const selectedServiceTypes = selectedItems.serviceType.map(item => item.name).join('ã€');
                const serviceTypeText = selectedServiceTypes ? `æœåŠ¡ç±»å‹: ${selectedServiceTypes}` : 'æœåŠ¡ç±»å‹: å…¨éƒ¨';
                
                const pdfContainer = document.createElement('div');
                pdfContainer.style.position = 'absolute';
                pdfContainer.style.left = '-9999px';
                pdfContainer.style.top = '0';
                pdfContainer.style.width = '1100px';
                pdfContainer.style.backgroundColor = 'white';
                pdfContainer.style.padding = '20px';
                pdfContainer.style.fontFamily = "'SimSun', 'STSong', 'SimHei', sans-serif";
                
                let tableHeader = '';
                if (selectedItems.serviceType.length > 0) {
                    tableHeader = `
                        <tr style="background-color: #f2f2f2;">
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">åç§°</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">æœåŠ¡ç±»å‹</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">å·¥å•æ•°</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">æœåŠ¡è®°å½•æ•°</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">æœåŠ¡è®°å½•ç‡</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">æœåŠ¡äººæ•°</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">å¹³å‡æ¯å•æœåŠ¡æ—¶é•¿</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">å¹³å‡æ¯äººæ¯æ—¥æœåŠ¡æ—¶é•¿</th>
                        </tr>
                    `;
                } else {
                    tableHeader = `
                        <tr style="background-color: #f2f2f2;">
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">åç§°</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">å·¥å•æ•°</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">æœåŠ¡è®°å½•æ•°</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">æœåŠ¡è®°å½•ç‡</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">æœåŠ¡äººæ•°</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">å¹³å‡æ¯å•æœåŠ¡æ—¶é•¿</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">å¹³å‡æ¯äººæ¯æ—¥æœåŠ¡æ—¶é•¿</th>
                        </tr>
                    `;
                }
                
                const tableRows = currentStats.map(stat => {
                    const formatDuration = (minutes) => {
                        const hours = Math.floor(minutes / 60);
                        const mins = Math.floor(minutes % 60);
                        return `${hours}å°æ—¶${mins}åˆ†é’Ÿ`;
                    };
                    
                    let rateColor = '#34a853';
                    if (stat.recordRate < 70) {
                        rateColor = '#ea4335';
                    } else if (stat.recordRate < 85) {
                        rateColor = '#fbbc04';
                    }
                    
                    let row = '';
                    if (selectedItems.serviceType.length > 0) {
                        row = `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">${stat.name}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${stat.serviceType}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${stat.totalOrders}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${stat.serviceRecords}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: ${rateColor}; font-weight: bold;">${stat.recordRate.toFixed(1)}%</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${stat.peopleCount}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${formatDuration(stat.avgDurationPerOrder)}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${formatDuration(stat.avgDailyPerPersonDuration)}</td>
                            </tr>
                        `;
                    } else {
                        row = `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">${stat.name}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${stat.totalOrders}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${stat.serviceRecords}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: ${rateColor}; font-weight: bold;">${stat.recordRate.toFixed(1)}%</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${stat.peopleCount}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${formatDuration(stat.avgDurationPerOrder)}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${formatDuration(stat.avgDailyPerPersonDuration)}</td>
                            </tr>
                        `;
                    }
                    return row;
                }).join('');
                
                const pdfContent = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h1 style="font-size: 24px; margin-bottom: 5px;">æœåŠ¡è®°å½•ç»Ÿè®¡åˆ†ææŠ¥è¡¨</h1>
                        <p style="font-size: 14px; color: #666;">ç»Ÿè®¡æ“ä½œå‘˜ã€å®¢æˆ·åœ°å€çš„æœåŠ¡è®°å½•æƒ…å†µ</p>
                    </div>
                    
                    <div style="margin-bottom: 20px; font-size: 12px;">
                        <p><strong>å¯¼å‡ºæ—¶é—´:</strong> ${new Date().toLocaleString('zh-CN')}</p>
                        <p><strong>æŸ¥è¯¢ç»´åº¦:</strong> ${currentQueryType === 'operator' ? 'æ“ä½œå‘˜' : 'å®¢æˆ·åœ°å€'}</p>
                        <p><strong>${serviceTypeText}</strong></p>
                        <p><strong>ç»Ÿè®¡æ—¶é—´æ®µ:</strong> ${document.getElementById('startDate').value} è‡³ ${document.getElementById('endDate').value}</p>
                    </div>
                    
                    <table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            ${tableHeader}
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 20px; font-size: 12px; color: #666;">
                        <p>ç»Ÿè®¡é¡¹æ•°: ${currentStats.length}</p>
                        <p>å¹³å‡æœåŠ¡è®°å½•ç‡: ${(currentStats.reduce((sum, stat) => sum + stat.recordRate, 0) / currentStats.length).toFixed(1)}%</p>
                        <p>å¹³å‡æ¯å•æœåŠ¡æ—¶é•¿: ${(() => {
                            const avgMinutes = currentStats.reduce((sum, stat) => sum + stat.avgDurationPerOrder, 0) / currentStats.length;
                            const hours = Math.floor(avgMinutes / 60);
                            const mins = Math.floor(avgMinutes % 60);
                            return `${hours}å°æ—¶${mins}åˆ†é’Ÿ`;
                        })()}</p>
                        <p>å¹³å‡æ¯äººæ¯æ—¥æœåŠ¡æ—¶é•¿: ${(() => {
                            const avgMinutes = currentStats.reduce((sum, stat) => sum + stat.avgDailyPerPersonDuration, 0) / currentStats.length;
                            const hours = Math.floor(avgMinutes / 60);
                            const mins = Math.floor(avgMinutes % 60);
                            return `${hours}å°æ—¶${mins}åˆ†é’Ÿ`;
                        })()}</p>
                    </div>
                `;
                
                pdfContainer.innerHTML = pdfContent;
                document.body.appendChild(pdfContainer);
                
                html2canvas(pdfContainer, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    document.body.removeChild(pdfContainer);
                    
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const imgWidth = pageWidth - 20;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    pdf.addImage(imgData, 'JPEG', 10, 10, imgWidth, imgHeight);
                    
                    const fileName = `æœåŠ¡è®°å½•ç»Ÿè®¡_${new Date().toISOString().slice(0, 10)}.pdf`;
                    
                    pdf.save(fileName);
                }).catch(error => {
                    document.body.removeChild(pdfContainer);
                    console.error('PDFå¯¼å‡ºé”™è¯¯:', error);
                    alert('PDFå¯¼å‡ºå¤±è´¥: ' + error.message);
                });
                
            } catch (error) {
                console.error('PDFå¯¼å‡ºé”™è¯¯:', error);
                alert('PDFå¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>
