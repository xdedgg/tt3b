<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœåŠ¡è®°å½•ç»Ÿè®¡åˆ†æ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            font-size: 14px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1a73e8 0%, #6c8ef5 100%);
            color: white;
            padding: 25px 30px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .main-content {
            display: flex;
            min-height: 600px;
        }
        
        .sidebar {
            width: 380px;
            background-color: #f9fafc;
            border-right: 1px solid #eaeaea;
            padding: 20px;
            overflow-y: auto;
        }
        
        .content {
            flex: 1;
            padding: 20px;
            overflow-x: auto;
        }
        
        .section-title {
            font-size: 18px;
            color: #1a73e8;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-export {
            background-color: #34a853;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: background-color 0.3s;
        }
        
        .btn-export:hover {
            background-color: #2e8b47;
        }
        
        .btn-export.pdf {
            background-color: #ea4335;
        }
        
        .btn-export.pdf:hover {
            background-color: #d33426;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #555;
            font-size: 13px;
        }
        
        .form-control {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
            transition: border 0.3s;
        }
        
        .form-control:focus {
            border-color: #1a73e8;
            outline: none;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        
        .date-range-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        .date-range-row .form-control {
            flex: 1;
        }
        
        .date-range-row span {
            color: #777;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #1a73e8;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0d62d9;
        }
        
        .btn-secondary {
            background-color: #f1f3f4;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #e3e6e8;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .statistics-summary {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .summary-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            flex: 1;
            min-width: 180px;
        }
        
        .summary-card.total-items {
            border-left: 4px solid #1a73e8;
        }
        
        .summary-card.total-orders {
            border-left: 4px solid #34a853;
        }
        
        .summary-card.total-service-records {
            border-left: 4px solid #ea4335;
        }
        
        .summary-card.total-people {
            border-left: 4px solid #fbbc04;
        }
        
        .summary-card.avg-record-rate {
            border-left: 4px solid #9c27b0;
        }
        
        .summary-card.avg-duration-per-order {
            border-left: 4px solid #00b894;
        }
        
        .summary-card.avg-daily-per-person {
            border-left: 4px solid #e17055;
        }
        
        .summary-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
        }
        
        .summary-value {
            font-size: 20px;
            font-weight: 700;
        }
        
        .summary-card.total-items .summary-value {
            color: #1a73e8;
        }
        
        .summary-card.total-orders .summary-value {
            color: #34a853;
        }
        
        .summary-card.total-service-records .summary-value {
            color: #ea4335;
        }
        
        .summary-card.total-people .summary-value {
            color: #fbbc04;
        }
        
        .summary-card.avg-record-rate .summary-value {
            color: #9c27b0;
        }
        
        .summary-card.avg-duration-per-order .summary-value {
            color: #00b894;
        }
        
        .summary-card.avg-daily-per-person .summary-value {
            color: #e17055;
        }
        
        .statistics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .statistics-table th {
            background-color: #f1f3f4;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #ddd;
            font-size: 13px;
        }
        
        .statistics-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
        }
        
        .statistics-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .percentage-cell {
            font-weight: 600;
            text-align: center;
        }
        
        .percentage-high {
            color: #34a853;
        }
        
        .percentage-medium {
            color: #fbbc04;
        }
        
        .percentage-low {
            color: #ea4335;
        }
        
        .duration-cell {
            font-weight: 600;
            text-align: center;
        }
        
        .people-cell {
            font-weight: 600;
            text-align: center;
        }
        
        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #777;
            font-size: 14px;
        }
        
        .no-data i {
            font-size: 40px;
            margin-bottom: 15px;
            color: #ccc;
        }
        
        /* æ ‘å½¢é€‰æ‹©å™¨æ ·å¼ */
        .tree-selector {
            margin-bottom: 20px;
        }
        
        .tree-selector .btn {
            width: 100%;
            text-align: left;
            position: relative;
            padding-right: 40px;
        }
        
        .tree-selector .btn::after {
            content: 'â–¼';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
        }
        
        .tree-selector .btn.active::after {
            content: 'â–²';
        }
        
        .tree-container {
            border: 1px solid #eaeaea;
            border-radius: 8px;
            padding: 15px;
            background-color: white;
            margin-top: 10px;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }
        
        .tree-container.active {
            display: block;
        }
        
        .tree-item {
            padding: 8px 10px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 13px;
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .tree-item:hover {
            background-color: #f0f7ff;
        }
        
        .tree-item.selected {
            background-color: #e3f2fd;
            font-weight: 600;
            color: #1a73e8;
        }
        
        .tree-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #666;
            font-size: 12px;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .tree-checkmark {
            width: 16px;
            height: 16px;
            border: 2px solid #ddd;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .tree-item.selected .tree-checkmark {
            background-color: #1a73e8;
            border-color: #1a73e8;
        }
        
        .tree-item.selected .tree-checkmark::after {
            content: 'âœ“';
            color: white;
            font-size: 12px;
        }
        
        .tree-item-text {
            flex: 1;
        }
        
        .tree-item.level-1 {
            padding-left: 10px;
        }
        
        .tree-item.level-2 {
            padding-left: 30px;
        }
        
        .tree-item.level-3 {
            padding-left: 50px;
        }
        
        /* å·²é€‰æ‹©æ ‡ç­¾æ ·å¼ */
        .selected-tags {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .selected-tag {
            background-color: #e3f2fd;
            border: 1px solid #1a73e8;
            border-radius: 15px;
            padding: 4px 10px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .remove-tag {
            background: none;
            border: none;
            color: #1a73e8;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-tag:hover {
            color: #ea4335;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #eaeaea;
                max-height: 500px;
            }
            
            .statistics-summary {
                flex-direction: column;
            }
        }
        
        @media (max-width: 768px) {
            .statistics-table {
                display: block;
                overflow-x: auto;
            }
            
            .date-range-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .export-buttons {
                flex-direction: column;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>æœåŠ¡è®°å½•ç»Ÿè®¡åˆ†æ</h1>
            <p>ç»Ÿè®¡å„éƒ¨é—¨ã€æ“ä½œå‘˜ã€å®¢æˆ·åœ°å€çš„æœåŠ¡è®°å½•æƒ…å†µ</p>
        </header>
        
        <div class="main-content">
            <div class="sidebar">
                <h2 class="section-title">ç»Ÿè®¡æ¡ä»¶è®¾ç½®</h2>
                
                <div class="tree-selector">
                    <button class="btn btn-secondary" onclick="toggleTree('department')" id="departmentBtn">é€‰æ‹©éƒ¨é—¨</button>
                    <div class="tree-container" id="departmentTree">
                        <!-- éƒ¨é—¨æ ‘å½¢ç»“æ„å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="selected-tags" id="departmentTags">
                        <!-- å·²é€‰æ‹©çš„éƒ¨é—¨æ ‡ç­¾å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="tree-selector">
                    <button class="btn btn-secondary" onclick="toggleTree('operator')" id="operatorBtn">é€‰æ‹©æ“ä½œå‘˜</button>
                    <div class="tree-container" id="operatorTree">
                        <!-- æ“ä½œå‘˜æ ‘å½¢ç»“æ„å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="selected-tags" id="operatorTags">
                        <!-- å·²é€‰æ‹©çš„æ“ä½œå‘˜æ ‡ç­¾å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="tree-selector">
                    <button class="btn btn-secondary" onclick="toggleTree('address')" id="addressBtn">é€‰æ‹©å®¢æˆ·åœ°å€</button>
                    <div class="tree-container" id="addressTree">
                        <!-- å®¢æˆ·åœ°å€æ ‘å½¢ç»“æ„å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="selected-tags" id="addressTags">
                        <!-- å·²é€‰æ‹©çš„å®¢æˆ·åœ°å€æ ‡ç­¾å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="dateRange">ç»Ÿè®¡æ—¶é—´æ®µ</label>
                    <div class="date-range-row">
                        <input type="date" id="startDate" class="form-control" value="2025-12-01">
                        <span>è‡³</span>
                        <input type="date" id="endDate" class="form-control" value="2025-12-01">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary btn-block" onclick="queryStatistics()">æŸ¥è¯¢ç»Ÿè®¡</button>
                    <button class="btn btn-secondary btn-block" onclick="resetForm()">é‡ç½®æ‰€æœ‰æ¡ä»¶</button>
                </div>
            </div>
            
            <div class="content">
                <div class="section-title">
                    <span>ç»Ÿè®¡ç»“æœ</span>
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToExcel()">å¯¼å‡ºExcel</button>
                        <button class="btn-export pdf" onclick="exportToPDF()">å¯¼å‡ºPDF</button>
                    </div>
                </div>
                
                <div class="statistics-summary" id="statisticsSummary">
                    <!-- ç»Ÿè®¡æ‘˜è¦ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="table-container">
                    <table class="statistics-table" id="resultTable">
                        <thead>
                            <tr>
                                <th>åç§°</th>
                                <th>å·¥å•æ•°</th>
                                <th>æœåŠ¡è®°å½•æ•°</th>
                                <th>æœåŠ¡è®°å½•ç‡</th>
                                <th>æœåŠ¡äººæ•°</th>
                                <th>å¹³å‡æ¯å•æœåŠ¡æ—¶é•¿</th>
                                <th>å¹³å‡æ¯äººæ¯æ—¥æœåŠ¡æ—¶é•¿</th>
                            </tr>
                        </thead>
                        <tbody id="resultBody">
                            <!-- ç»Ÿè®¡æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="no-data" id="noDataMessage">
                    <div>ğŸ“Š</div>
                    <h3>æš‚æ— ç»Ÿè®¡æ•°æ®</h3>
                    <p>è¯·è®¾ç½®ç»Ÿè®¡æ¡ä»¶å¹¶ç‚¹å‡»"æŸ¥è¯¢ç»Ÿè®¡"æŒ‰é’®æŸ¥çœ‹ç»“æœ</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç”Ÿæˆæ¨¡æ‹Ÿæ“ä½œå‘˜å§“å
        function generateOperators(count, prefix) {
            const surnames = ['ç‹', 'æ', 'å¼ ', 'åˆ˜', 'é™ˆ', 'æ¨', 'èµµ', 'é»„', 'å‘¨', 'å´', 
                           'å¾', 'å­™', 'èƒ¡', 'æœ±', 'é«˜', 'æ—', 'ä½•', 'éƒ­', 'é©¬', 'ç½—'];
            const names = ['ä¼Ÿ', 'èŠ³', 'å¨œ', 'ç§€è‹±', 'æ•', 'é™', 'ä¸½', 'å¼º', 'ç£Š', 'å†›', 
                         'æ´‹', 'å‹‡', 'è‰³', 'æ°', 'å¨Ÿ', 'æ¶›', 'æ˜', 'è¶…', 'ç§€å…°', 'éœ', 
                         'å¹³', 'åˆš', 'æ¡‚è‹±', 'åš', 'æ–‡', 'å', 'å»ºå›½', 'çº¢', 'é¹', 'ç‰å…°'];
            
            const operators = [];
            for (let i = 1; i <= count; i++) {
                const surname = surnames[Math.floor(Math.random() * surnames.length)];
                const name = names[Math.floor(Math.random() * names.length)];
                const id = String(520000 + i).padStart(6, '0');
                operators.push({
                    id: `${prefix}-op${i}`,
                    name: `${surname}${name}ï¼ˆ${id}ï¼‰`,
                    level: 2,
                    children: []
                });
            }
            return operators;
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿç½‘æ ¼åç§°
        function generateGrids(count, prefix) {
            const areas = ['ä¸œ', 'è¥¿', 'å—', 'åŒ—', 'ä¸­', 'æ–°', 'è€', 'å¤§', 'å°'];
            const types = ['ç½‘æ ¼'];
            
            const grids = [];
            for (let i = 1; i <= count; i++) {
                const area = areas[Math.floor(Math.random() * areas.length)];
                const type = types[Math.floor(Math.random() * types.length)];
                grids.push({
                    id: `${prefix}-grid${i}`,
                    name: `${area}${type}${i}`,
                    level: 3,
                    children: []
                });
            }
            return grids;
        }

        // ç»„ç»‡ç»“æ„æ•°æ®
        const organizationalStructure = {
            departments: [
                {
                    id: "æ€»å…¬å¸",
                    name: "æ€»å…¬å¸",
                    level: 1,
                    expanded: false,
                    children: [
                        {
                            id: "å’Œå¹³æ²³è¥¿åˆ†å…¬å¸",
                            name: "å’Œå¹³æ²³è¥¿åˆ†å…¬å¸",
                            level: 2,
                            expanded: false,
                            children: [
                                { id: "å’Œå¹³", name: "å’Œå¹³", level: 3, expanded: false, children: [] },
                                { id: "æ²³è¥¿", name: "æ²³è¥¿", level: 3, expanded: false, children: [] }
                            ]
                        },
                        {
                            id: "æ»¨æµ·åˆ†å…¬å¸",
                            name: "æ»¨æµ·åˆ†å…¬å¸",
                            level: 2,
                            expanded: false,
                            children: [
                                { id: "å¡˜æ²½", name: "å¡˜æ²½", level: 3, expanded: false, children: [] },
                                { id: "æ±‰æ²½", name: "æ±‰æ²½", level: 3, expanded: false, children: [] },
                                { id: "å¤§æ¸¯", name: "å¤§æ¸¯", level: 3, expanded: false, children: [] }
                            ]
                        },
                        {
                            id: "åŒ—è¾°åˆ†å…¬å¸",
                            name: "åŒ—è¾°åˆ†å…¬å¸",
                            level: 2,
                            expanded: false,
                            children: [
                                { id: "åŒ—è¾°", name: "åŒ—è¾°", level: 3, expanded: false, children: [] }
                            ]
                        }
                    ]
                }
            ],
            
            operators: [
                {
                    id: "å’Œå¹³æ²³è¥¿åˆ†å…¬å¸",
                    name: "å’Œå¹³æ²³è¥¿åˆ†å…¬å¸",
                    level: 1,
                    expanded: false,
                    children: generateOperators(10, "å’Œå¹³æ²³è¥¿")
                },
                {
                    id: "æ»¨æµ·åˆ†å…¬å¸",
                    name: "æ»¨æµ·åˆ†å…¬å¸",
                    level: 1,
                    expanded: false,
                    children: generateOperators(20, "æ»¨æµ·")
                },
                {
                    id: "åŒ—è¾°åˆ†å…¬å¸",
                    name: "åŒ—è¾°åˆ†å…¬å¸",
                    level: 1,
                    expanded: false,
                    children: generateOperators(7, "åŒ—è¾°")
                }
            ],
            
            addresses: [
                {
                    id: "æ€»å…¬å¸",
                    name: "æ€»å…¬å¸",
                    level: 1,
                    expanded: false,
                    children: [
                        {
                            id: "å’Œå¹³æ²³è¥¿åˆ†å…¬å¸",
                            name: "å’Œå¹³æ²³è¥¿åˆ†å…¬å¸",
                            level: 2,
                            expanded: false,
                            children: generateGrids(5, "å’Œå¹³æ²³è¥¿")
                        },
                        {
                            id: "æ»¨æµ·åˆ†å…¬å¸",
                            name: "æ»¨æµ·åˆ†å…¬å¸",
                            level: 2,
                            expanded: false,
                            children: generateGrids(5, "æ»¨æµ·")
                        },
                        {
                            id: "åŒ—è¾°åˆ†å…¬å¸",
                            name: "åŒ—è¾°åˆ†å…¬å¸",
                            level: 2,
                            expanded: false,
                            children: generateGrids(5, "åŒ—è¾°")
                        }
                    ]
                }
            ]
        };

        // å…¨å±€å˜é‡
        let selectedItems = {
            department: [],
            operator: [],
            address: []
        };
        
        let currentTree = null;
        let currentQueryType = null;
        let currentStats = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ ‘å½¢é€‰æ‹©å™¨
            initTreeSelectors();
            
            // é»˜è®¤æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
            queryStatistics();
        });

        // åˆå§‹åŒ–æ ‘å½¢é€‰æ‹©å™¨
        function initTreeSelectors() {
            // åˆå§‹åŒ–éƒ¨é—¨æ ‘
            const departmentTree = document.getElementById('departmentTree');
            departmentTree.innerHTML = generateTreeHTML(organizationalStructure.departments, 'department');
            
            // åˆå§‹åŒ–æ“ä½œå‘˜æ ‘
            const operatorTree = document.getElementById('operatorTree');
            operatorTree.innerHTML = generateTreeHTML(organizationalStructure.operators, 'operator');
            
            // åˆå§‹åŒ–å®¢æˆ·åœ°å€æ ‘
            const addressTree = document.getElementById('addressTree');
            addressTree.innerHTML = generateTreeHTML(organizationalStructure.addresses, 'address');
            
            // æ›´æ–°å·²é€‰æ‹©æ ‡ç­¾
            updateSelectedTags();
        }

        // ç”Ÿæˆæ ‘å½¢ç»“æ„HTML
        function generateTreeHTML(nodes, type, parentExpanded = true) {
            let html = '';
            
            nodes.forEach(node => {
                const isSelected = selectedItems[type].some(item => item.id === node.id);
                const hasChildren = node.children && node.children.length > 0;
                const showChildren = parentExpanded && node.expanded;
                
                html += `
                    <div class="tree-item level-${node.level} ${isSelected ? 'selected' : ''}" 
                         onclick="handleTreeItemClick(event, '${type}', '${node.id}')">
                        ${hasChildren ? `
                            <div class="tree-toggle" onclick="toggleTreeNode(event, '${type}', '${node.id}')">
                                ${node.expanded ? 'âˆ’' : '+'}
                            </div>
                        ` : '<div class="tree-toggle" style="visibility: hidden;"></div>'}
                        <div class="tree-checkmark"></div>
                        <div class="tree-item-text">${node.name}</div>
                    </div>
                `;
                
                if (hasChildren && showChildren) {
                    html += generateTreeHTML(node.children, type, showChildren);
                }
            });
            
            return html;
        }

        // åˆ‡æ¢æ ‘èŠ‚ç‚¹å±•å¼€/æŠ˜å 
        function toggleTreeNode(event, type, nodeId) {
            event.stopPropagation();
            
            const nodes = type === 'department' ? organizationalStructure.departments :
                         type === 'operator' ? organizationalStructure.operators :
                         organizationalStructure.addresses;
            
            const toggleNode = (nodeList) => {
                for (let node of nodeList) {
                    if (node.id === nodeId) {
                        node.expanded = !node.expanded;
                        return true;
                    }
                    if (node.children && node.children.length > 0) {
                        if (toggleNode(node.children)) {
                            return true;
                        }
                    }
                }
                return false;
            };
            
            toggleNode(nodes);
            
            // é‡æ–°ç”Ÿæˆæ ‘å½¢ç»“æ„HTML
            const treeElement = document.getElementById(type + 'Tree');
            treeElement.innerHTML = generateTreeHTML(nodes, type);
        }

        // å¤„ç†æ ‘èŠ‚ç‚¹ç‚¹å‡»
        function handleTreeItemClick(event, type, nodeId) {
            event.stopPropagation();
            
            const nodes = type === 'department' ? organizationalStructure.departments :
                         type === 'operator' ? organizationalStructure.operators :
                         organizationalStructure.addresses;
            
            // æŸ¥æ‰¾èŠ‚ç‚¹
            const findNode = (nodeList) => {
                for (let node of nodeList) {
                    if (node.id === nodeId) {
                        return node;
                    }
                    if (node.children && node.children.length > 0) {
                        const found = findNode(node.children);
                        if (found) return found;
                    }
                }
                return null;
            };
            
            const node = findNode(nodes);
            if (!node) return;
            
            // è·å–è¯¥èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬è‡ªèº«å’Œå­èŠ‚ç‚¹ï¼‰
            const getAllNodes = (currentNode) => {
                const nodes = [currentNode];
                if (currentNode.children && currentNode.children.length > 0) {
                    currentNode.children.forEach(child => {
                        nodes.push(...getAllNodes(child));
                    });
                }
                return nodes;
            };
            
            const allNodes = getAllNodes(node);
            
            // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©
            const isSelected = selectedItems[type].some(item => item.id === nodeId);
            
            if (isSelected) {
                // ç§»é™¤é€‰æ‹©ï¼šç§»é™¤è¯¥èŠ‚ç‚¹åŠå…¶æ‰€æœ‰å­èŠ‚ç‚¹
                allNodes.forEach(n => {
                    const index = selectedItems[type].findIndex(item => item.id === n.id);
                    if (index !== -1) {
                        selectedItems[type].splice(index, 1);
                    }
                });
            } else {
                // æ·»åŠ é€‰æ‹©ï¼šæ·»åŠ è¯¥èŠ‚ç‚¹åŠå…¶æ‰€æœ‰å­èŠ‚ç‚¹
                allNodes.forEach(n => {
                    if (!selectedItems[type].some(item => item.id === n.id)) {
                        selectedItems[type].push({ id: n.id, name: n.name, level: n.level });
                    }
                });
            }
            
            // é‡æ–°ç”Ÿæˆæ ‘å½¢ç»“æ„HTML
            const treeElement = document.getElementById(type + 'Tree');
            treeElement.innerHTML = generateTreeHTML(nodes, type);
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            document.getElementById(type + 'Btn').textContent = `é€‰æ‹©${getTypeName(type)} (${selectedItems[type].length}é¡¹)`;
            
            // æ›´æ–°å·²é€‰æ‹©æ ‡ç­¾
            updateSelectedTags();
        }

        // åˆ‡æ¢æ ‘å½¢é€‰æ‹©å™¨æ˜¾ç¤º/éšè—
        function toggleTree(type) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰å·²æ‰“å¼€çš„æ ‘ï¼Œåˆ™å…³é—­å®ƒ
            if (currentTree === type) {
                document.getElementById(type + 'Tree').classList.remove('active');
                document.getElementById(type + 'Btn').classList.remove('active');
                currentTree = null;
                return;
            }
            
            // å…³é—­ä¹‹å‰æ‰“å¼€çš„æ ‘
            if (currentTree) {
                document.getElementById(currentTree + 'Tree').classList.remove('active');
                document.getElementById(currentTree + 'Btn').classList.remove('active');
            }
            
            // æ¸…ç©ºå…¶ä»–ç»´åº¦çš„é€‰æ‹©
            const otherTypes = ['department', 'operator', 'address'].filter(t => t !== type);
            otherTypes.forEach(otherType => {
                selectedItems[otherType] = [];
                document.getElementById(otherType + 'Btn').textContent = `é€‰æ‹©${getTypeName(otherType)}`;
                
                // é‡æ–°ç”Ÿæˆæ ‘ä»¥æ¸…é™¤é€‰ä¸­çŠ¶æ€
                const nodes = otherType === 'department' ? organizationalStructure.departments :
                             otherType === 'operator' ? organizationalStructure.operators :
                             organizationalStructure.addresses;
                const treeElement = document.getElementById(otherType + 'Tree');
                treeElement.innerHTML = generateTreeHTML(nodes, otherType);
            });
            
            // æ‰“å¼€å½“å‰æ ‘
            currentTree = type;
            document.getElementById(type + 'Tree').classList.add('active');
            document.getElementById(type + 'Btn').classList.add('active');
            document.getElementById(type + 'Btn').textContent = `é€‰æ‹©${getTypeName(type)} (${selectedItems[type].length}é¡¹)`;
            
            // æ›´æ–°å·²é€‰æ‹©æ ‡ç­¾
            updateSelectedTags();
        }

        // è·å–ç±»å‹åç§°
        function getTypeName(type) {
            const names = {
                department: 'éƒ¨é—¨',
                operator: 'æ“ä½œå‘˜',
                address: 'å®¢æˆ·åœ°å€'
            };
            return names[type] || type;
        }

        // æ›´æ–°å·²é€‰æ‹©æ ‡ç­¾
        function updateSelectedTags() {
            // æ›´æ–°éƒ¨é—¨æ ‡ç­¾
            const departmentTags = document.getElementById('departmentTags');
            departmentTags.innerHTML = selectedItems.department.map(item => `
                <div class="selected-tag">
                    ${item.name}
                    <button class="remove-tag" onclick="removeSelectedItem('department', '${item.id}')">&times;</button>
                </div>
            `).join('');
            
            // æ›´æ–°æ“ä½œå‘˜æ ‡ç­¾
            const operatorTags = document.getElementById('operatorTags');
            operatorTags.innerHTML = selectedItems.operator.map(item => `
                <div class="selected-tag">
                    ${item.name}
                    <button class="remove-tag" onclick="removeSelectedItem('operator', '${item.id}')">&times;</button>
                </div>
            `).join('');
            
            // æ›´æ–°å®¢æˆ·åœ°å€æ ‡ç­¾
            const addressTags = document.getElementById('addressTags');
            addressTags.innerHTML = selectedItems.address.map(item => `
                <div class="selected-tag">
                    ${item.name}
                    <button class="remove-tag" onclick="removeSelectedItem('address', '${item.id}')">&times;</button>
                </div>
            `).join('');
        }

        // ç§»é™¤å·²é€‰æ‹©é¡¹ç›®
        function removeSelectedItem(type, id) {
            const index = selectedItems[type].findIndex(item => item.id === id);
            if (index !== -1) {
                selectedItems[type].splice(index, 1);
                
                // é‡æ–°ç”Ÿæˆæ ‘å½¢ç»“æ„HTMLä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
                const treeElement = document.getElementById(type + 'Tree');
                const nodes = type === 'department' ? organizationalStructure.departments :
                             type === 'operator' ? organizationalStructure.operators :
                             organizationalStructure.addresses;
                treeElement.innerHTML = generateTreeHTML(nodes, type);
                
                // æ›´æ–°æŒ‰é’®æ–‡æœ¬
                document.getElementById(type + 'Btn').textContent = `é€‰æ‹©${getTypeName(type)} (${selectedItems[type].length}é¡¹)`;
                
                // æ›´æ–°å·²é€‰æ‹©æ ‡ç­¾
                updateSelectedTags();
            }
        }

        // æŸ¥è¯¢ç»Ÿè®¡æ•°æ®
        function queryStatistics() {
            // å…³é—­æ‰€æœ‰æ ‘å½¢é€‰æ‹©å™¨
            if (currentTree) {
                document.getElementById(currentTree + 'Tree').classList.remove('active');
                document.getElementById(currentTree + 'Btn').classList.remove('active');
                currentTree = null;
            }
            
            // ç¡®å®šæŸ¥è¯¢ç»´åº¦
            let queryType = null;
            let queryItems = [];
            
            if (selectedItems.department.length > 0) {
                queryType = 'department';
                queryItems = selectedItems.department;
            } else if (selectedItems.operator.length > 0) {
                queryType = 'operator';
                queryItems = selectedItems.operator;
            } else if (selectedItems.address.length > 0) {
                queryType = 'address';
                queryItems = selectedItems.address;
            } else {
                // é»˜è®¤æŸ¥è¯¢æ‰€æœ‰éƒ¨é—¨
                queryType = 'department';
                queryItems = getAllLeafNodes(organizationalStructure.departments);
            }
            
            // ä¿å­˜å½“å‰æŸ¥è¯¢ç±»å‹
            currentQueryType = queryType;
            
            // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
            currentStats = generateMockStats(queryItems, queryType);
            
            // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
            displayStats(currentStats, queryType);
            
            // æ›´æ–°æ‘˜è¦ç»Ÿè®¡
            updateSummaryStats(currentStats, queryType);
        }

        // è·å–æ‰€æœ‰å¶å­èŠ‚ç‚¹
        function getAllLeafNodes(nodes) {
            let leafNodes = [];
            
            nodes.forEach(node => {
                if (node.children && node.children.length > 0) {
                    leafNodes = leafNodes.concat(getAllLeafNodes(node.children));
                } else {
                    leafNodes.push({ id: node.id, name: node.name, level: node.level });
                }
            });
            
            return leafNodes;
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿç»Ÿè®¡æ•°æ®
function generateMockStats(items, type) {
    return items.map(item => {
        // æœåŠ¡äººæ•°ï¼šå½“é€‰æ‹©æ¡ä»¶ä¸ºæ“ä½œå‘˜æ—¶ï¼ŒæœåŠ¡äººæ•°æ˜¾ç¤ºä¸º1
        // å…¶ä»–æƒ…å†µä¸‹ï¼šæ¯ä¸ªç½‘æ ¼2-7ä¹‹é—´ï¼Œæ¯ä¸ªåˆ†å…¬å¸ä¸è¶…è¿‡40äºº
        let peopleCount;
        if (type === 'operator') {
            peopleCount = 1; // æ“ä½œå‘˜ç»´åº¦ï¼ŒæœåŠ¡äººæ•°å›ºå®šä¸º1
        } else {
            peopleCount = Math.floor(Math.random() * 6) + 2; // 2-7äºº
            
            // å¦‚æœæ˜¯åˆ†å…¬å¸çº§åˆ«ï¼Œç¡®ä¿ä¸è¶…è¿‡40äºº
            if (item.level === 2 && type === 'department') {
                peopleCount = Math.min(peopleCount * 5, 40); // å‡è®¾æ¯ä¸ªåˆ†å…¬å¸æœ‰5ä¸ªç½‘æ ¼
            }
        }
        
        // å·¥å•æ•°ï¼šæœåŠ¡äººæ•°ä¹˜ä»¥3-9ä¹‹é—´çš„éšæœºæ•´æ•°
        const multiplier = Math.floor(Math.random() * 7) + 3; // 3-9ä¹‹é—´çš„éšæœºæ•´æ•°
        const totalOrders = peopleCount * multiplier;
        
        // æœåŠ¡è®°å½•æ•°ï¼šå°äºå·¥å•æ•°ä¸”å¤§äºå·¥å•æ•°çš„60%
        const minRecords = Math.max(1, Math.floor(totalOrders * 0.6));
        const serviceRecords = Math.floor(Math.random() * (totalOrders - minRecords)) + minRecords;
        
        // æœåŠ¡è®°å½•ç‡ï¼š46%åˆ°99%ä¹‹é—´
        const recordRate = (Math.random() * 53 + 46).toFixed(1);
        
        // å¹³å‡æ¯å•æœåŠ¡æ—¶é•¿ï¼š16åˆ†é’Ÿåˆ°3å°æ—¶55åˆ†é’Ÿä¹‹é—´ï¼ˆ16-235åˆ†é’Ÿï¼‰
        const avgDurationPerOrder = Math.floor(Math.random() * 220) + 16;
        
        // å¹³å‡æ¯äººæ¯æ—¥æœåŠ¡æ—¶é•¿ï¼š2å°æ—¶2åˆ†é’Ÿåˆ°7å°æ—¶8åˆ†é’Ÿä¹‹é—´ï¼ˆ122-428åˆ†é’Ÿï¼‰
        const avgDailyPerPersonDuration = Math.floor(Math.random() * 307) + 122;
        
        return {
            name: item.name,
            totalOrders: totalOrders,
            serviceRecords: serviceRecords,
            recordRate: parseFloat(recordRate),
            peopleCount: peopleCount,
            avgDurationPerOrder: avgDurationPerOrder,
            avgDailyPerPersonDuration: avgDailyPerPersonDuration
        };
    });
}

        // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
        function displayStats(stats, type) {
            const resultBody = document.getElementById('resultBody');
            const noDataMessage = document.getElementById('noDataMessage');
            
            if (stats.length === 0) {
                resultBody.innerHTML = '';
                noDataMessage.style.display = 'block';
                return;
            }
            
            noDataMessage.style.display = 'none';
            
            let rowsHTML = '';
            stats.forEach(stat => {
                // æ ¹æ®æœåŠ¡è®°å½•ç‡ç¡®å®šé¢œè‰²
                let rateClass = 'percentage-high';
                if (stat.recordRate < 70) {
                    rateClass = 'percentage-low';
                } else if (stat.recordRate < 85) {
                    rateClass = 'percentage-medium';
                }
                
                // æ ¼å¼åŒ–æ—¶é•¿æ˜¾ç¤º
                const formatDuration = (minutes) => {
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    return `${hours}å°æ—¶${mins}åˆ†é’Ÿ`;
                };
                
                rowsHTML += `
                    <tr>
                        <td><strong>${stat.name}</strong></td>
                        <td class="people-cell">${stat.totalOrders}</td>
                        <td class="people-cell">${stat.serviceRecords}</td>
                        <td class="percentage-cell ${rateClass}">${stat.recordRate.toFixed(1)}%</td>
                        <td class="people-cell">${stat.peopleCount}</td>
                        <td class="duration-cell">${formatDuration(stat.avgDurationPerOrder)}</td>
                        <td class="duration-cell">${formatDuration(stat.avgDailyPerPersonDuration)}</td>
                    </tr>
                `;
            });
            
            resultBody.innerHTML = rowsHTML;
        }

        // æ›´æ–°ç»Ÿè®¡æ‘˜è¦
        function updateSummaryStats(stats, type) {
            const summaryElement = document.getElementById('statisticsSummary');
            
            if (stats.length === 0) {
                summaryElement.innerHTML = `
                    <div class="summary-card total-items">
                        <div class="summary-title">ç»Ÿè®¡é¡¹æ•°</div>
                        <div class="summary-value">0</div>
                    </div>
                `;
                return;
            }
            
            // è®¡ç®—æ€»ä½“ç»Ÿè®¡
            const totalOrders = stats.reduce((sum, stat) => sum + stat.totalOrders, 0);
            const totalServiceRecords = stats.reduce((sum, stat) => sum + stat.serviceRecords, 0);
            const totalPeople = stats.reduce((sum, stat) => sum + stat.peopleCount, 0);
            const avgRecordRate = totalOrders > 0 ? (totalServiceRecords / totalOrders * 100).toFixed(1) : 0;
            const avgDurationPerOrder = stats.reduce((sum, stat) => sum + stat.avgDurationPerOrder, 0) / stats.length;
            const avgDailyPerPersonDuration = stats.reduce((sum, stat) => sum + stat.avgDailyPerPersonDuration, 0) / stats.length;
            
            // æ ¼å¼åŒ–æ—¶é•¿æ˜¾ç¤º
            const formatDuration = (minutes) => {
                const hours = Math.floor(minutes / 60);
                const mins = Math.round(minutes % 60);
                return `${hours}å°æ—¶${mins}åˆ†é’Ÿ`;
            };
            
            const summaryHTML = `
                <div class="summary-card total-items">
                    <div class="summary-title">ç»Ÿè®¡é¡¹æ•°</div>
                    <div class="summary-value">${stats.length}</div>
                </div>
                <div class="summary-card total-orders">
                    <div class="summary-title">æ€»å·¥å•æ•°</div>
                    <div class="summary-value">${totalOrders}</div>
                </div>
                <div class="summary-card total-service-records">
                    <div class="summary-title">æ€»æœåŠ¡è®°å½•æ•°</div>
                    <div class="summary-value">${totalServiceRecords}</div>
                </div>
                <div class="summary-card total-people">
                    <div class="summary-title">æ€»æœåŠ¡äººæ•°</div>
                    <div class="summary-value">${totalPeople}</div>
                </div>
                <div class="summary-card avg-record-rate">
                    <div class="summary-title">å¹³å‡æœåŠ¡è®°å½•ç‡</div>
                    <div class="summary-value">${avgRecordRate}%</div>
                </div>
                <div class="summary-card avg-duration-per-order">
                    <div class="summary-title">å¹³å‡æ¯å•æœåŠ¡æ—¶é•¿</div>
                    <div class="summary-value">${formatDuration(avgDurationPerOrder)}</div>
                </div>
                <div class="summary-card avg-daily-per-person">
                    <div class="summary-title">å¹³å‡æ¯äººæ¯æ—¥æœåŠ¡æ—¶é•¿</div>
                    <div class="summary-value">${formatDuration(avgDailyPerPersonDuration)}</div>
                </div>
            `;
            
            summaryElement.innerHTML = summaryHTML;
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            // é‡ç½®æ—¥æœŸ
            document.getElementById('startDate').value = '2025-12-01';
            document.getElementById('endDate').value = '2025-12-01';
            
            // é‡ç½®é€‰æ‹©
            selectedItems = {
                department: [],
                operator: [],
                address: []
            };
            
            // é‡ç½®æ‰€æœ‰æ ‘çš„å±•å¼€çŠ¶æ€
            const resetExpandedState = (nodes) => {
                nodes.forEach(node => {
                    node.expanded = false;
                    if (node.children && node.children.length > 0) {
                        resetExpandedState(node.children);
                    }
                });
            };
            
            resetExpandedState(organizationalStructure.departments);
            resetExpandedState(organizationalStructure.operators);
            resetExpandedState(organizationalStructure.addresses);
            
            // å…³é—­æ‰€æœ‰æ ‘å½¢é€‰æ‹©å™¨
            if (currentTree) {
                document.getElementById(currentTree + 'Tree').classList.remove('active');
                document.getElementById(currentTree + 'Btn').classList.remove('active');
                currentTree = null;
            }
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            document.getElementById('departmentBtn').textContent = 'é€‰æ‹©éƒ¨é—¨';
            document.getElementById('operatorBtn').textContent = 'é€‰æ‹©æ“ä½œå‘˜';
            document.getElementById('addressBtn').textContent = 'é€‰æ‹©å®¢æˆ·åœ°å€';
            
            // é‡æ–°åˆå§‹åŒ–æ ‘å½¢é€‰æ‹©å™¨
            initTreeSelectors();
            
            // æ˜¾ç¤ºé»˜è®¤ç»Ÿè®¡æ•°æ®ï¼ˆæ‰€æœ‰éƒ¨é—¨ï¼‰
            queryStatistics();
        }

        // å¯¼å‡ºåˆ°Excel
        function exportToExcel() {
            if (currentStats.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }
            
            // å‡†å¤‡æ•°æ®
            const data = [
                ['æœåŠ¡è®°å½•ç»Ÿè®¡åˆ†ææŠ¥è¡¨'],
                ['å¯¼å‡ºæ—¶é—´: ' + new Date().toLocaleString('zh-CN')],
                ['æŸ¥è¯¢ç»´åº¦: ' + (currentQueryType === 'department' ? 'éƒ¨é—¨' : currentQueryType === 'operator' ? 'æ“ä½œå‘˜' : 'å®¢æˆ·åœ°å€')],
                ['ç»Ÿè®¡æ—¶é—´æ®µ: ' + document.getElementById('startDate').value + ' è‡³ ' + document.getElementById('endDate').value],
                [''],
                ['åç§°', 'å·¥å•æ•°', 'æœåŠ¡è®°å½•æ•°', 'æœåŠ¡è®°å½•ç‡', 'æœåŠ¡äººæ•°', 'å¹³å‡æ¯å•æœåŠ¡æ—¶é•¿', 'å¹³å‡æ¯äººæ¯æ—¥æœåŠ¡æ—¶é•¿']
            ];
            
            // æ·»åŠ ç»Ÿè®¡æ•°æ®
            currentStats.forEach(stat => {
                const formatDuration = (minutes) => {
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    return `${hours}å°æ—¶${mins}åˆ†é’Ÿ`;
                };
                
                data.push([
                    stat.name,
                    stat.totalOrders,
                    stat.serviceRecords,
                    stat.recordRate.toFixed(1) + '%',
                    stat.peopleCount,
                    formatDuration(stat.avgDurationPerOrder),
                    formatDuration(stat.avgDailyPerPersonDuration)
                ]);
            });
            
            // åˆ›å»ºworkbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // è®¾ç½®åˆ—å®½
            const colWidths = [
                {wch: 30}, // åç§°
                {wch: 10}, // å·¥å•æ•°
                {wch: 12}, // æœåŠ¡è®°å½•æ•°
                {wch: 12}, // æœåŠ¡è®°å½•ç‡
                {wch: 10}, // æœåŠ¡äººæ•°
                {wch: 18}, // å¹³å‡æ¯å•æœåŠ¡æ—¶é•¿
                {wch: 20}  // å¹³å‡æ¯äººæ¯æ—¥æœåŠ¡æ—¶é•¿
            ];
            ws['!cols'] = colWidths;
            
            // åˆå¹¶æ ‡é¢˜è¡Œ
            ws['!merges'] = [
                XLSX.utils.decode_range("A1:G1"),
                XLSX.utils.decode_range("A2:G2"),
                XLSX.utils.decode_range("A3:G3"),
                XLSX.utils.decode_range("A4:G4")
            ];
            
            // æ·»åŠ åˆ°workbook
            XLSX.utils.book_append_sheet(wb, ws, "æœåŠ¡è®°å½•ç»Ÿè®¡");
            
            // ç”Ÿæˆæ–‡ä»¶å
            const fileName = `æœåŠ¡è®°å½•ç»Ÿè®¡_${new Date().toISOString().slice(0, 10)}.xlsx`;
            
            // å¯¼å‡º
            XLSX.writeFile(wb, fileName);
        }

        // å¯¼å‡ºåˆ°PDF
        function exportToPDF() {
            if (currentStats.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }
            
            // åˆ›å»ºPDFæ–‡æ¡£
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            // æ ‡é¢˜
            doc.setFontSize(16);
            doc.text('æœåŠ¡è®°å½•ç»Ÿè®¡åˆ†ææŠ¥è¡¨', 105, 15, { align: 'center' });
            
            // å¯¼å‡ºä¿¡æ¯
            doc.setFontSize(10);
            doc.text(`å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString('zh-CN')}`, 10, 25);
            doc.text(`æŸ¥è¯¢ç»´åº¦: ${currentQueryType === 'department' ? 'éƒ¨é—¨' : currentQueryType === 'operator' ? 'æ“ä½œå‘˜' : 'å®¢æˆ·åœ°å€'}`, 10, 30);
            doc.text(`ç»Ÿè®¡æ—¶é—´æ®µ: ${document.getElementById('startDate').value} è‡³ ${document.getElementById('endDate').value}`, 10, 35);
            
            // è¡¨å¤´
            const headers = ['åç§°', 'å·¥å•æ•°', 'æœåŠ¡è®°å½•æ•°', 'æœåŠ¡è®°å½•ç‡', 'æœåŠ¡äººæ•°', 'å¹³å‡æ¯å•æœåŠ¡æ—¶é•¿', 'å¹³å‡æ¯äººæ¯æ—¥æœåŠ¡æ—¶é•¿'];
            const columnWidths = [50, 20, 25, 25, 20, 35, 40];
            let startY = 45;
            
            // ç»˜åˆ¶è¡¨å¤´
            doc.setFillColor(241, 243, 244);
            doc.rect(10, startY, 270, 8, 'F');
            doc.setFontSize(11);
            doc.setTextColor(85, 85, 85);
            
            let currentX = 10;
            headers.forEach((header, index) => {
                doc.text(header, currentX + columnWidths[index]/2, startY + 5.5, { align: 'center' });
                currentX += columnWidths[index];
            });
            
            startY += 8;
            
            // ç»˜åˆ¶æ•°æ®è¡Œ
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            currentStats.forEach((stat, rowIndex) => {
                if (startY > 270) { // æ¢é¡µ
                    doc.addPage();
                    startY = 20;
                    // åœ¨æ–°é¡µé¢ä¸Šé‡æ–°ç»˜åˆ¶è¡¨å¤´
                    doc.setFillColor(241, 243, 244);
                    doc.rect(10, startY, 270, 8, 'F');
                    doc.setFontSize(11);
                    doc.setTextColor(85, 85, 85);
                    
                    currentX = 10;
                    headers.forEach((header, index) => {
                        doc.text(header, currentX + columnWidths[index]/2, startY + 5.5, { align: 'center' });
                        currentX += columnWidths[index];
                    });
                    
                    startY += 8;
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                }
                
                // æ ¼å¼åŒ–æ—¶é•¿
                const formatDuration = (minutes) => {
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    return `${hours}å°æ—¶${mins}åˆ†é’Ÿ`;
                };
                
                const rowData = [
                    stat.name,
                    stat.totalOrders.toString(),
                    stat.serviceRecords.toString(),
                    stat.recordRate.toFixed(1) + '%',
                    stat.peopleCount.toString(),
                    formatDuration(stat.avgDurationPerOrder),
                    formatDuration(stat.avgDailyPerPersonDuration)
                ];
                
                currentX = 10;
                rowData.forEach((cell, colIndex) => {
                    if (colIndex === 0) {
                        doc.setFont(undefined, 'bold');
                    }
                    
                    doc.text(cell, currentX + 2, startY + 5.5, { maxWidth: columnWidths[colIndex] - 4 });
                    
                    if (colIndex === 0) {
                        doc.setFont(undefined, 'normal');
                    }
                    currentX += columnWidths[colIndex];
                });
                
                // ç»˜åˆ¶è¡Œåˆ†éš”çº¿
                doc.setDrawColor(238, 238, 238);
                doc.line(10, startY + 8, 280, startY + 8);
                
                startY += 8;
            });
            
            // ç”Ÿæˆæ–‡ä»¶å
            const fileName = `æœåŠ¡è®°å½•ç»Ÿè®¡_${new Date().toISOString().slice(0, 10)}.pdf`;
            
            // ä¿å­˜PDF
            doc.save(fileName);
        }
    </script>
</body>
</html>